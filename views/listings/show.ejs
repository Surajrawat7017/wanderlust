<% layout('/layouts/boilerplate.ejs') -%>

<script>
  const mapToken = '<%= process.env.mapToken %>';
  const list = <%- JSON.stringify(list) %>;
</script>

<body>
  <div class="row box">
    <div class="col">
      <h1 class="heading"><%= list.title %></h1>
    </div>

    <div class="card col-6 details-card" style="width:40rem;">
      <img src="<%= list.image.url %>" class="card-img-top" alt="card-img">

      <div class="card-body">
        <p><%= list.description %></p>
        <p><b>&#8377 <%= list.price.toLocaleString('en-IN') %></b></p>
        <p><%= list.location %></p>
        <p><%= list.country %></p>
        <p>
          <b>Creator:</b> @<%= list.owner?.username || "Unknown" %>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <b>Category:</b> <%= list.category %>
        </p>

        <% if (curruser && list.owner && curruser._id.equals(list.owner._id)) { %>
          <div class="row">
            <div class="col-3">
              <form method="GET" action="/listings/<%= list._id %>/edit">
                <button class="btn btn-dark edit">Edit</button>
              </form>
            </div>
            <div class="col-3">
              <form method="POST" action="/listings/<%= list._id %>?_method=DELETE">
                <button class="btn btn-dark delete">Delete</button>
              </form>
            </div>
          </div>
        <% } %>
      </div>

      <% if (curruser) { %>
        <hr>
        <div class="review-box m-1 p-3">
          <p><b>Leave a Review</b></p>

          <form method="POST" action="/listings/<%= list._id %>/review" class="needs-validation" novalidate>
            <fieldset class="starability-slot">
              <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked>
              <input type="radio" id="rate1" name="review[rating]" value="1"><label for="rate1">1</label>
              <input type="radio" id="rate2" name="review[rating]" value="2"><label for="rate2">2</label>
              <input type="radio" id="rate3" name="review[rating]" value="3"><label for="rate3">3</label>
              <input type="radio" id="rate4" name="review[rating]" value="4"><label for="rate4">4</label>
              <input type="radio" id="rate5" name="review[rating]" value="5"><label for="rate5">5</label>
            </fieldset>

            <div class="form-group m-2">
              <label for="comment" class="form-label">Comments</label>
              <textarea name="review[comment]" cols="30" rows="3" class="form-control" id="comment" required></textarea>
              <div class="invalid-feedback">Please give Feedback</div>
            </div>

            <button class="btn btn-primary m-2">Submit</button>
          </form>
        </div>
      <% } %>

      <hr>

      <% if (list.reviews.length > 0) { %>
        <div class="row">
          <% for (const review of list.reviews) { %>
            <div class="card m-2 review-card" style="width: 18rem;">
              <div class="card-body">
                <p><%= review.author?.username || "Anonymous" %></p>

                <div class="star d-flex justify-content-between align-items-center">
                  <p class="mb-2 fs-4"><%= review.rating %>.0</p>
                  <p class="starability-result" data-rating="<%= review.rating %>">
                    Rated: <%= review.rating %> stars
                  </p>
                </div>

                <p class="card-subtitle mb-2 text-muted"><%= review.comment %></p>
              </div>

              <% if (curruser && review.author && curruser._id.equals(review.author._id)) { %>
                <form method="POST" action="/listings/<%= list._id %>/review/<%= review._id %>?_method=DELETE">
                  <button class="btn btn-dark m-2">Delete</button>
                </form>
              <% } %>
            </div>
          <% } %>
        </div>
        <hr>
      <% } %>

      <h5>Where youâ€™ll be</h5>
      <div id="map" class="map-style"></div>
    </div>
  </div>
</body>

<script src="/js/map.js"></script>
